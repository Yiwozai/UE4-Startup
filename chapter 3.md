# 三、 引擎指南

## 1. 图形和渲染

### ①渲染概述
虚幻引擎 4 拥有全新的、DirectX 11 管线的渲染系统，包括延迟着色，全局光照，半透明光照，后处理以及使用矢量场的 GPU 粒子模拟。 

- 延迟着色：材质将它们的属性写入 GBuffers，光照过程则读取材质每个像素的属性，并对他们执行光照处理。 

- 光照路径：完全动态、部分静态或完全静态。这几个不同的工具在质量、性能和游戏中的可变性直接具有不同的取舍。

- 带光照的半透明物体： 半透明物体的光照和着色都是单次的，这样可以确保将其正确地与其他半透明物体混合，而如果采用多遍光照技术是无法完成的。 
![半透明效果](\image\5-1.jpg)

- 子表面着色：材质拥有了全新的光照模型 MLM_Subsurface，此模型是为了蜡或翡翠等看似不透明，但光照在内部会散射的材质打造。这种相对于一般的表面渲染质量稍低一些，但性能则更高效。 
![翡翠材质](\image\5-2.jpg)

- GPU粒子：虚幻 4 支持在 GPU 上的粒子模拟。传统 CPU 计算体系能够在一帧内完成数以千计的粒子。而在 GPU 上的模拟运算则可以让以十万计的粒子被计算并有效的渲染。

- 矢量场：除了高效外，GPU 粒子最有趣的功能，就是矢量场。矢量场是一个能对粒子运动产生统一影响的矢量网格。矢量场被作为 Actor 放置在世界中，而且可以像其它 Actor 一样被平移，旋转和缩放。并且它们是动态的，可以在任何时候被移动。 
![矢量场](\image\5-3.jpg)

- 后期特效：虚幻引擎 4 提供多种后期特效，这样美术人员和设计人员可以对场景最终的画面效果和感觉进行整体调整。这些元素和特效的示例包括光溢出（明亮物体上的 HDR 光溢出效果）、环境遮挡以及色调映射。 
- 环境遮挡：环境遮挡 效果是 SSAO（屏幕空间环境遮挡）的一种实现方式，并且当前仅基于深度缓冲。这意味着法线贴图细节或平滑组不会影响效果。 在启用该功能后，多边形数非常低的网格物体可能会呈现出更多的棱角。
- 光溢出：光溢出 是真实世界中的一种光照现象，该效果可以在中度的渲染开销下，为渲染出的图像增加更多的真实感。 当我们用裸眼看非常亮的对象并且背景非常暗时，就会看到这种光溢出现象。尽管比较亮的对象也会产生其它的效果（如条纹、镜头眩光），但是这里讨论的典型的光溢出特效并不包含其他效果。 由于我们的显示器（比如 TV、TFT……）通常不支持 HDR（高动态范围），所以我际上并不能渲染非常亮的对象。 取而代之的做法是，只是模拟以下的情况发生后的效果，比如光照在视网膜表面的散射，或者光照射到薄膜（薄膜表面散射），以及相机前方（乳白色玻璃滤镜）的效果。 这类效果并不总是完全在物理学上显示正确，但却能帮助表现对象的相对亮度，或给 LDR（低动态范围 Low Dynamic Range）图片增加真实感。 
![光溢出](\image\5-4.jpg)

- 人眼适应：人眼适应，或称 自动曝光，可以会自动调整场景的曝光度，重现从明亮环境进入黑暗环境（或相反）时所经历的效果。 
- 镜头眩光：镜头眩光 效果是基于图像技术，会在镜头转向明亮物体时自动产生镜头的眩光效果。 
![眩光](\image\5-5.jpg)
---
### ②材质
使用着色器控制世界中的表面外形。用专业的术语来说，当穿过场景的光照接触到表面后，材质被用来计算该光照如何与该表面进行互动。这些计算是通过对材质的输入数据来完成的，而这些输入数据来自于一系列图像（贴图）以及数学表达式，以及材质本身所继承的不同属性设置。 

#### 基本材质概念
材质是让您的对象和关卡具有您想要的外观的关键因素之一。本文档介绍一种快速且高级别的方法来创建您自己的材质。 
1. 材质表达式节点与网络

   关于材质，您需要知道的第一件也是最重要的事情就是，它们并非通过代码，而是通过材质编辑器中的可视化脚本节点（称为材质表达式）所组成的网络来构建。每一个节点都包含 HLSL 代码 片段，并用于执行特定的任务。这意味着当您构建材质时，您是在通过可视化脚本编程来创建 HLSL 代码。 
   ![](\image\5-6.jpg)
   在这个例子中，我们有一个非常简单的网络，它用来定义硬木地板。然而，材质表达式网络并非如此简单。有些材质经常会包含数十个材质表达式节点。 
2. 使用颜色和数字

   正如您所知，颜色在数字成像方面，由 4 个主通道构成。它们是：R-红色，G-绿色，B-蓝色和A-阿尔法。对所有数字图像中的每一个像素而言，其中任何通道的值都可以由一个数字表示。关于材质的许多工作无非是根据一系列的情况和数学表达式来处理这些数字。 

   在 UE4 中考虑材质时，请记住，许多表达式的运作与各个颜色通道无关。例如，对于每个通道，“加法”（Add） 节点使用两个输入并将它们相加。如果您将两个 RGB 颜色（3 通道矢量值）相加，那么输出颜色将是：(红色 1+红色 2, 绿色 1+绿色 2, 蓝色 1+蓝色 2)。
3. 纹理

   对于材质，纹理只是用于提供某种基于像素的数据的图像。这些数据可能是对象的颜色、光泽度、透明度以及各种其他方面。有一种过时的想法，认为“添加纹理”是给游戏模型上色的过程。虽然创建纹理的过程仍然很关键，但我们应该将纹理看作材质的“元件”，而不是将它们本身视为最终成品，这一点很重要。 

   一个单一材质有可能用到几个不同的纹理贴图作为不同的目的效果。比如，一个简单的材质可能会有一个基础颜色的纹理贴图，一个高光纹理，一个法线贴图。除此以外，还有可能有保存在透明通道中的自发光贴图以及粗造度贴图。 

4. 属性与输入

   您可以对材质执行的许多操作是由您对材质本身设置的各种属性，以及您建立并连接定义材质的材质表达式节点网络的方式来驱动的。为了能够全面运用虚幻引擎材质系统的强大功能，检视可用的属性和输入十分有益。您可以在下列位置找到它们： TODO: 超链接

#### 材质操作指南
有关使用 Unreal Engine 4 中材质编辑器的操作指南。 （详细图文、视频教程请查看[官方文档](https://docs.unrealengine.com/zh-CN/Engine/Rendering/Materials/HowTo/index.html)）

1. 使用主材质节点

   材质图的主材质节点是所有添加到材质图中的材质表达式节点最终连接的位置。 主材质节点的输入所产生的结果将在材质编译后应用于游戏中的对象时展现。 

   ##### 主材质节点
   材质 是使用一种称为 高级着色语言 （简称 HLSL）的专用编码语言来创建的。 HLSL 使材质能够直接与图形硬件交互，让美工和程序员可以更好地控制屏幕上显示的内容。 在虚幻引擎 4 (UE4) 中，用来创建材质的材质表达式节点包含这种 HLSL 代码的小片段。 为了显示所有这些 HLSL 代码小片段的结果，我们使用主材质节点。

2. UV 坐标动画

   为材质添加运动的能力不可或缺，当您尝试重新创建诸如火焰、流水或烟雾之类的效果时尤其如此。 在虚幻引擎 4 (UE4) 中，实现此功能的一种低成本、有效方法是使用 平移（Panner）材质表达式 节点。 “平移”（Panner）材质表达式节点允许沿 U 或 V 方向或者同时沿这两个方向移动纹理的 UV 坐标。 

3. 凹凸贴图偏移（Bump Offset）

   凹凸贴图偏移（Bump Offset）贴图通过以创新的方式修改 UV 坐标来帮助强化纹素与对象表面的错位，从而营造出表面细节超出实际情况的错觉。 
   ![](\image\5-7.jpg)

4. 透明涂层双法线

   透明涂层着色模型现在可以为透明涂层以下的表面添加第二法线贴图。这样可以更精确地为复杂的材质建模，如表面与透明涂层存在几何差异的碳纤维。
   ![双法线 On](\image\5-8.jpg) ![双法线 Off](\image\5-9.jpg)

5. 彩色半透明阴影

   设置和使用 半透明阴影颜色 来创建可以投射彩色阴影的材质，为场景注入一些颜色适合于许多应用，但最常用于彩绘玻璃窗等物品。 
   ![](\image\5-10.jpg)

6. 分层材质

   在这个简短教程中，我们将概述创建简单 分层材质 的过程，该材质包含两个材质层：铬合金和雪。最终的分层材质会自动将雪置于对象的顶部表面，从而在两种材质之间有效地进行切换。材质之间的混合将总是检查顶部表面，这意味着即使您旋转对象，雪也总是停留在顶部。 
   ![](\image\5-11.jpg)

7. 细节纹理

   以非常近的距离查看材质时，您会注意到，材质中使用的纹理会细化为像素点，导致视觉效果欠佳。 为了解决此问题，您可以使用“细节纹理”，来帮助隐藏以非常近的距离查看材质时产生的纹理像素化。
   ![左图具有细节纹理，右图不具有](\image\5-12.jpg)

8. 自发光材质

   在项目开发过程中，可能会需要自发亮材质或发光材质。向任何材质添加自发光光照都是一种系统开销低且非常有效的方法，这样可以模拟光源，而不必添加任何新光源。 但是，请记住，使用自发光光照时，自发光光照不会像普通光源那样照亮动态对象（例如角色）。 另外，如果辉光过强，请记得调整“后期处理体积（Post Process Volume）”的“泛光（Bloom）”设置。 
   ![](\image\5-13.jpg)

9. 创建和使用材质实例

   如果必须创建、设置和调整标准材质，那么这可能是一个非常耗时的过程。 为了帮助加速和简化这个过程，虚幻引擎4提供了一种特殊类型的材质，称为 材质实例（Material Instance）。

10. 创建材质函数

    在一个材质图中复用另一个材质图的部分内容，可以节省材质创建时间，并加快材质工作流程的速度。 在虚幻引擎 4 (UE4) 中，用户可使用 材质函数 来实现此功能。

11. 编写材质参数

    为了与材质实例互动，您需要使用名为 材质参数 的特殊材质表达式节点。与材质实例配合使用时，材质参数就是一种非常强大且实用的工具，可以添加几乎无穷无尽、各种各样的材质。 但请记住，如需使用材质参数，则必须使用材质实例。 

12. 使用纹理遮罩

    创建 3D 资产时，您可能需要在同一材质中定义不同的表面类型。 实现此目标的一种简单而低成本的方法是使用 纹理蒙版，它可定义哪个表面应该受材质的哪个部分影响。 纹理遮罩是功能非常强大的概念，您一旦掌握此概念，就可以使用非常少量的来源内容创建几乎无穷无尽的变化。 请记住，对于每个蒙版纹理，只有 4 个可以与其配合使用的通道，因此您应该明智地加以使用。 另外，请不要忘记对蒙版纹理禁用 sRGB，因为这对提高蒙版清晰度有很大帮助。 
    ![](\image\5-14.jpg)

13. 使用折射

    向材质（特别是玻璃和水）添加折射可产生非常逼真的效果。 请记住使用您尝试模拟的表面类型的正确 IOR 值。 您也可能很希望将 IOR 值增大到超过表面类型的正确 IOR 值，但务必克制这种冲动。 IOR 值源自现实世界中的测量值，所以，将 IOR 值增大或减小到合理水平以外并不会产生更好的效果。 
    ![](\image\5-15.jpg)

14. 次表面轮廓

    渲染逼真人体皮肤的能力，对于任何现代电子游戏引擎来说都不可或缺。为了满足此需求，虚幻引擎4（UE4）现在提供了一种专门用于皮肤或蜡状表面的明暗处理方法，称为 次表面轮廓。
    ![](\image\5-16.jpg)

15. 次表面散射

    “次表面散射”术语用来描述光线穿过透明/半透明表面时发生散射的照明现象。 虚幻引擎 4 (UE4) 提供了称为 次表面 的特殊 着色模型，专门用于需要此类互动的材质，例如皮肤或蜡状物。
    ![](\image\5-17.jpg)

16. 使用透明度

    创建特定表面类型（例如，水面或玻璃）时，您需要能够使该表面不仅通透，还具有某种深度和颜色感。 
    ![](\image\5-18.jpg)

17. 网格体贴花

    创建一个可应用至静态网格体的基础延迟贴花材质。
    ![](\image\5-19.jpg)